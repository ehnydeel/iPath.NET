@namespace iPath.Blazor.Componenents.Nodes
@using Tizzani.MudBlazor.HtmlEditor

@inject NodeViewModel vm;
@inject IStringLocalizer T

<MudForm Model="Model" Class="@Class" @ref="frm">
    <MudGrid>
        <MudItem xs="12" sm="8">
            <MudTextField Label=@T["Title"] @bind-Value="Model.Title" For="@(() => Model.Title)"
                          Variant="Variant" Margin="@Margin"
                          AutoFocus="true" Required="true" />

            <MudTextField Label=@T["Subtitle"] @bind-Value="Model.Subtitle" Variant="Variant" Margin="@Margin" ShrinkLabel="true" />

            <MudPaper Elevation="0" Class="mt-4 mb-2">
                <MudText Typo="Typo.subtitle2">@T["Desciption"]</MudText>

                @if (useQuestionnaire)
                {
                    <iPath.LHCForms.LhcForm @ref="lhcForm" ReadOnly="false" />
                }
                else if (useHtmlEditor)
                {
                    <MudHtmlEditor @bind-Html="Model.Text" style="min-height: 12em;">
                        <MudHtmlToolbarOptions InsertImage="false" />
                    </MudHtmlEditor>
                }
                else
                {
                    <MudTextField @bind-Value="Model.Text" Lines="6" AutoGrow="true"
                                  Variant="Variant" />
                }
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="4">
            <!--
            <MudTextField Label=@T["Case Type"] @bind-Value="Model.CaseType" Variant="Variant" Margin="@Margin" ShrinkLabel="true" />
            -->
            <CaseTypeLookup Label=@T["Case Type"] GroupId="GroupId" @bind-Value="Model.CaseType" Variant="Variant"
                            Clearable="true" Dense="true" CoerceValue="true" Margin="@Margin" ShrinkLabel="true" />
            <MudTextField Label=@T["Accession No"] @bind-Value="Model.AccessionNo" Variant="Variant" Margin="@Margin" ShrinkLabel="true" />

            
            <NodeDescriptionBodySite Model="Model" Group="vm.ActiveGroup" />
        </MudItem>
    </MudGrid>
</MudForm>

@code {
    [Parameter, EditorRequired]
    public NodeDescription Model { get; set; }

    [Parameter, EditorRequired]
    public Guid GroupId { get; set; }

    [Parameter]
    public string Class { get; set; }

    [Parameter]
    public Variant Variant { get; set; } = Variant.Outlined;

    [Parameter]
    public Margin Margin { get; set; } = Margin.Dense;

    private iPath.LHCForms.LhcForm lhcForm;

    bool useQuestionnaire => !string.IsNullOrEmpty(Model?.QuestionnaireId);
    bool useHtmlEditor = true;

    private MudForm frm;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && useQuestionnaire)
        {
            var q = vm.GetQuesiotnnaire(Model);
            if (q is not null)
            {
                var qResource = await vm.GetQuesiotnnaire(Model);
                if (!string.IsNullOrEmpty(qResource))
                {
                    await lhcForm.LoadFormAsync(qResource, Model.QuestionnaireResponse);
                }
            }
        }
    }


    public async Task Validate()
    {
        if (useQuestionnaire)
        {
            Model.QuestionnaireResponse = await lhcForm.GetDataAsync() ?? "";
        }
        else
        {
            Model.QuestionnaireResponse = "";
        }

        await frm.Validate();
    }

    public bool IsValid => frm.IsValid;
}
