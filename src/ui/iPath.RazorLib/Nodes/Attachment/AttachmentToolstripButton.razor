@namespace iPath.Blazor.Componenents.Nodes
@using System.Threading.Tasks
@inherits NodeViewComponentBase

@if (!uploading)
{
    <MudFileUpload T="IReadOnlyList<IBrowserFile>" AppendMultipleFiles
                       OnFilesChanged="OnInputFileChanged">
        <ActivatorContent>
            <MudIconButton Icon="@Icons.Material.Outlined.AttachFile" Disabled="vm.AttachFileDisabled" />
        </ActivatorContent>
    </MudFileUpload>
}
else
{
    <MudProgressCircular Value="@progress" Indeterminate="true" />
}

@code {
    private bool uploading;
    int progress = 0;

    private async Task OnInputFileChanged(InputFileChangeEventArgs e)
    {
        uploading = true;
        try
        {
            var files = e.GetMultipleFiles();
            var total = files.Count();
            var i = 0;
            foreach (var file in files)
            {
                i++;
                progress = (100 * i / total);

                var res = await vm.UploadFile(file);
            }
        }
        catch (Exception ex)
        {
            snackbar.AddError(ex.Message);
        }
        finally
        {
            uploading = false;
        }
        await vm.ReloadNode();
    }

}
