@namespace iPath.Blazor.Componenents.Nodes
@inherits NodeViewComponentBase

<style>
    .file-upload-input {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 10;
        opacity: 0;
    }
    .drop-zone{
        border: dashed 1px;
        padding: 1em;
        min-height: 10em;
        width: 100%;
        background-color: antiquewhite;
    }
</style>


@if (vm.RootNode is not null)
{
    <MudStack>
        <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                       @ref="@upload"
                       OnFilesChanged="OnInputFileChanged"
                       AppendMultipleFiles
                       Hidden="@false"
                       InputClass="file-upload-input"
                       tabindex="-1"
                       @ondrop="@ClearDragClass"
                       @ondragenter="@SetDragClass"
                       @ondragleave="@ClearDragClass"
                       @ondragend="@ClearDragClass">
            <ActivatorContent>
                <div class="sortableGallery drop-zone">
                    <div id="gallery" class="gallery">
                        @foreach (var f in _files)
                        {
                            <div class="gallery-item" data-id="@f.Id">
                            <MudIcon Size="Size.Large" Icon="@f.Icon" />
                            <br />
                                <div class="gallery-item-label">@f.Filename.ShortenTo(12)</div>
                            </div>
                        }
                    </div>
                </div>
            </ActivatorContent>
        </MudFileUpload>

        <MudToolBar Gutters="true" Class="d-flex gap-4">
            <MudButton Color="Color.Primary"
                       OnClick="@OpenFilePickerAsync"
                       Variant="Variant.Filled">
                Open file picker
            </MudButton>
            <MudButton Color="Color.Primary"
                       Disabled="@(!_files.Any())"
                       OnClick="@Upload"
                       Variant="Variant.Filled">
                Upload
            </MudButton>
            <MudButton Color="Color.Error"
                       Disabled="@(!_files.Any())"
                       OnClick="@ClearAsync"
                       Variant="Variant.Filled">
                Clear
            </MudButton>
        </MudToolBar>
    </MudStack>
}

@code {
    [Parameter]
    public RenderFragment ActivatorContent { get; set; }

    List<FileUpload> _files = new();

    MudFileUpload<IReadOnlyList<IBrowserFile>>? upload;
    private void OnInputFileChanged(InputFileChangeEventArgs e)
    {
        ClearDragClass();
        var files = e.GetMultipleFiles();
        foreach (var file in files)
        {
            _files.Add(new FileUpload(file));
        }
    }

    private async Task ClearAsync()
    {
        await (upload?.ClearAsync() ?? Task.CompletedTask);
        _files.Clear();
        ClearDragClass();
    }

    private Task OpenFilePickerAsync()
        => upload?.OpenFilePickerAsync() ?? Task.CompletedTask;

    private void Upload()
    {
        // Upload the files here
        snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
        snackbar.Add("TODO: Upload your files!");
    }

    private const string DefaultDragClass = "relative rounded-lg border-2 border-dashed pa-4 mt-4 mud-width-full mud-height-full";
    private string _dragClass = DefaultDragClass;

    private void SetDragClass()
        => _dragClass = $"{DefaultDragClass} mud-border-primary";

    private void ClearDragClass()
        => _dragClass = DefaultDragClass;



    public class FileUpload
    {
        public readonly Guid Id;
        public IBrowserFile file { get; private set; }

        public FileUpload (IBrowserFile f)
        {
            Id = Guid.CreateVersion7();
            file = f;
        }

        public string Filename => file.Name;
        public string ContentType => file.ContentType;
        public string Icon => Icons.Material.TwoTone.FileUpload;
    }
}


