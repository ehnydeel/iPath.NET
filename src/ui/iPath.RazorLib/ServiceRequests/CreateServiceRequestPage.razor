@page "/request/create/{groupId}"

@inherits ServiceRequestViewComponentBase

@inject GroupListViewModel gvm



@if (vm.SelectedRequest is not null)
{
    <ServiceRequestHeader />

    @if (vm.ActiveGroup.Settings.UseDescriptionWizzard)
    {
        <ServiceRequestCreateWizzard CodingService="icdo" ValueSetId="icdo-topo" />
    }
    else
    {
        <ServiceRequestEditForm Model="vm.SelectedRequest.Description" @bind-Owner="vm.RequestOwner" @ref="frm"
                                GroupId="vm.SelectedRequest.GroupId.Value" Variant="Variant.Outlined" Class="my-8 z-50" />

        <GalleryDropZone />

        <MudStack Row Spacing="4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save"
                       OnClick="OnSave">@SaveText</MudButton>
            <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Cancel"
                       OnClick=@(() => vm.CancelEdit())>Cancel</MudButton>
            <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete"
                       OnClick=@(() => vm.Delete(false))>Delete</MudButton>
        </MudStack>
    }
}

@code {
    [Parameter]
    public string groupId { get; set; }

    private GroupDto Group = null!;


    ServiceRequestEditForm frm;

    string SaveText = "Save";
    string Title = "New Case";


    protected override async Task OnParametersSetAsync()
    {
        if (Guid.TryParse(groupId, out var GroupId))
        {
            Group = await gvm.GetGroupDto(GroupId);
            await vm.CreateNewNode(Group.Id);

            StateHasChanged();
        }
    }

    async Task OnSave()
    {
        await frm.Validate();
        if (frm.IsValid)
        {
            await vm.Save();
        }
    }

    protected override void OnDisposed()
    {
        if (vm.IsEditing)
            vm.CancelEdit();
    }
}
