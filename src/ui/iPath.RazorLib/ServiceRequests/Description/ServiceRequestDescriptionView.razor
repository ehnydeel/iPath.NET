@namespace iPath.Blazor.Componenents.ServiceRequests

@inherits ServiceRequestViewComponentBase

@if (vm.SelectedRequest is not null)
{
    @if (ExpandDescription)
    {
        <div class="ipath_node">
            <div class="ipath_node_title">
                <div class="ipath_bold">
                    <MudHighlighter Text="@vm.SelectedRequest.Title" HighlightedText="@vm.SearchString" />
                    <span>@vm.SelectedRequest.Description.BodySite?.ToAppend()</span>
                </div>
                <div>@vm.SelectedRequest.SubTitle</div>
                @if (!string.IsNullOrEmpty(PatientText))
                {
                    <div><strong>@T["Patient"]:</strong> @PatientText</div>
                }
            </div>
            <div class="ipath_node_type">
                <div class="ipath_bold">Type:</div>
                <div>@vm.SelectedRequest.CaseType</div>
            </div>
            <div class="ipath_node_sender">
                <div class="ipath_bold">Sender:</div>
                <OwnerLink Owner="vm.SelectedRequest.Owner" />
            </div>
            <div class="ipath_node_date">
                <b><GroupLink GroupId="@vm.SelectedRequest.GroupId" /></b>
                <div>@vm.SelectedRequest.CreatedOn.ToString("d")</div>
            </div>
        </div>



        @if (!string.IsNullOrEmpty(@vm.SelectedRequest?.Description?.Text))
        {
            <div class="ipath_node_description">
                <MudHighlighter Text="@vm.SelectedRequest.DescriptionHtml" Markup="true" HighlightedText="@vm.SearchString" />
            </div>
        }
        
        @if (vm.SelectedRequest?.Description?.Questionnaire is not null)
        {
            <ServiceRequestQuestionnaire Model="@vm.SelectedRequest.Description" />
        }
    }
    else
    {
        <div class="ipath_node">
            <div class="ipath_node_title2">
                <div><b>Filename: </b>@vm.SelectedDocument.GalleryCaption.ShortenTo(50)</div>
                <div onclick="@ToggleDescription">
                    <MudIcon Icon="@ExpandIcon" Size="Size.Small" />
                    <b>@vm.SelectedRequest.Title</b>
                </div>
                <div class="ipath_node_description" hidden="@HideDescription">
                    @vm.SelectedRequest.DescriptionMarkup
                </div>
            </div>
            <div class="ipath_node_sender2">
                <div>
                    <b>Sender:</b> <OwnerLink Owner="vm.SelectedRequest.Owner" />
                </div>
                <div><b>Type:</b> @vm.SelectedRequest.CaseType</div>
            </div>
            <div class="ipath_node_date2">
                <div>@vm.SelectedRequest.CreatedOn.ToString("d")</div>
                @if (@vm.SelectedDocument is not null)
                {
                    <div>@vm.SelectedDocument.GalleryCaption.ShortenTo(20)</div>
                }
            </div>
        </div>
    }
}



@code {
    [Parameter]
    public bool ExpandDescription { get; set; } = true;

    [Parameter]
    public EventCallback<bool> ExpandDescriptionChanged { get; set; }

    [Parameter]
    public bool HideDescription { get; set; } = true;

    string ExpandIcon => HideDescription ? Icons.Material.Filled.ExpandMore : Icons.Material.Filled.ExpandLess;

    void ToggleDescription()
    {
        HideDescription = !HideDescription;
    }

    string PatientText
    {
        get
        {
            string ret = "";
            if (!string.IsNullOrEmpty(vm.SelectedRequest.Description.PatientInfo.Gender))
            {
                ret = ret.Append(vm.SelectedRequest.Description.PatientInfo.Gender);
            }
            if (vm.SelectedRequest.Description.PatientInfo.Age.HasValue)
            {
                ret = ret.Append($"{vm.SelectedRequest.Description.PatientInfo.Age} years");
            }

            return ret;
        }
    }

}