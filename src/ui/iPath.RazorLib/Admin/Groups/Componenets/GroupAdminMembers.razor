@namespace iPath.Blazor.Componenents.Admin.Groups

@inject GroupAdminViewModel vm
@inject IStringLocalizer T
@inject NavigationManager nm

@if (Model is not null)
{
    <MudDataGrid T="GroupMemberDto" ServerData="vm.GetMembersAsync" @ref="memberGrid"
                 Dense="true" Striped="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">@T["Members"]</MudText>
            <MudSpacer />
            <OwnerLookup Label=@T["Select user"] Dense="true" Variant="Variant.Outlined" @bind-Value="userToAdd" />
            <MudTooltip Text=@T["Add user to group"]>
                <MudFab Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small"
                        StartIcon="@Icons.Material.Filled.Add" Class="ml-2"
                        OnClick="AddUser" />
            </MudTooltip>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="g => g.Username" />
            <PropertyColumn Property="g => g.Role" />
            <TemplateColumn CellClass="d-flex justify-end">
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" OnClick=@(() => RemoveUser(context.Item)) />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="GroupMemberDto" />
        </PagerContent>
    </MudDataGrid>

    <MudButton Href="admin/groups" Variant="Variant.Filled" Class="mt-10">Ok</MudButton>
}

@code {
    [Parameter, EditorRequired]
    public GroupDto Model { get; set; }

    MudDataGrid<GroupMemberDto> memberGrid;

    OwnerDto userToAdd;
    private async Task AddUser()
    {
        if (userToAdd != null)
        {
            await vm.AddGroupMember(userToAdd);
            userToAdd = null;
            await memberGrid.ReloadServerData();
        }
    }

    private async Task RemoveUser(GroupMemberDto m)
    {
        await vm.RemoveGroupMember(m);
        await memberGrid.ReloadServerData();
    }
}