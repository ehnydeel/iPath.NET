@namespace iPath.Blazor.Componenents.Admin.Groups

@inject GroupAdminViewModel vm
@inject IStringLocalizer T
@inject NavigationManager nm

@if (Model is null)
{
    <LoadingMessage />
}
else
{
    <MudDataGrid T="CommunityListDto" Items="@Communities" Dense="true" Class="ipath_table"
                 FixedHeader="true" Height="400px" Virtualize="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">@T["Extra Communities"]</MudText>
            <MudSpacer />
            <CommunityLookup Label=@T["add to community"] @bind-Value="communityToAdd"
                             Variant="Variant.Outlined" ShrinkLabel="true" Dense="true" Margin="Margin.Dense" />
            <MudTooltip Text=@T["Make the group visible in this community"]>
                <MudFab StartIcon="@Icons.Material.Filled.Add" Class="ml-2" Size="Size.Small" OnClick="AddCommunity"
                        Disabled=@(communityToAdd is null) />
            </MudTooltip>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="c => c.Name" />
            <TemplateColumn CellClass="d-flex justify-end">
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" OnClick=@(() => RemoveCommunity(context.Item)) />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>

    <MudAlert Severity="Severity.Info" Class="border-2 mt-2 px-4 pa-0">
        <strong>@T["Main communit"]:</strong> @(Model.Community?.Name)
    </MudAlert>

    <MudButton Href="admin/groups" Variant="Variant.Filled" Class="mt-4">Ok</MudButton>
}

@code {
    [Parameter, EditorRequired]
    public GroupDto Model { get; set; }

    protected override void OnParametersSet()
    {
        LoadData();
    }

    private void LoadData()
    {
        if (Model is not null)
        {
            Communities = Model.ExtraCommunities is null ? new() : Model.ExtraCommunities.ToList();
            StateHasChanged();
        }
    }


    IEnumerable<CommunityListDto> Communities;
    CommunityListDto communityToAdd;
    private async Task AddCommunity()
    {
        if (communityToAdd != null)
        {
            await vm.AddToCommunity(communityToAdd);
            communityToAdd = null;
            Model = await vm.ReloadGroup();
            LoadData();
        }
    }
    private async Task RemoveCommunity(CommunityListDto c)
    {
        await vm.RemoveFromCommunity(c);
        Model = await vm.ReloadGroup();
        LoadData();
    }

}