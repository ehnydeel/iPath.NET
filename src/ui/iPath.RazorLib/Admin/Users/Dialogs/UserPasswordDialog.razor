@namespace iPath.Blazor.Componenents.Admin.Users
@using System.ComponentModel.DataAnnotations
@using iPath.Application.Features.ServiceRequests
<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Reset Password for @User?.Username</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm Model="Model">
            <MudTextField Label="Password" InputType="InputType.Password" @bind-Value="Model.Password" />
            <MudTextField Label="Confirm" InputType="InputType.Password" @bind-Value="Model.Confirmation" />
            <MudCheckBox Label="Email validated" @bind-Value="Model.EmailValidated" />
        </MudForm>
        <p class="mt-4">@msg</p>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save">Save</MudButton>
        <MudButton Variant="Variant.Filled" OnClick="Cancel">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@inject UserAdminViewModel vm
@inject IStringLocalizer T

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public UserDto User { get; set; }

    PasswordResetModel Model = new();
    string msg;


    async Task Save()
    {
        if (string.IsNullOrEmpty(Model.Password) || Model.Password != Model.Confirmation)
        {
            msg = "passwords do not not match";
            return;
        }

        var cmd = new UpdateUserPasswordCommand { UserId = User.Id, Password = Model.Password, SetEmailValidated = Model.EmailValidated };
        var resp = await vm.UpdateUserPassword(cmd);
        if (resp.IsFailed)
        {
            msg = resp.Errors.FirstOrDefault()?.Message;
            return;
        }

        MudDialog.Close(true);
    }

    private void Cancel() => MudDialog.Cancel();


    private class PasswordResetModel
    {
        [Required]
        public string Password { get; set; }

        [Required]
        public string Confirmation { get; set; }

        public bool EmailValidated { get; set; }
    }
}
