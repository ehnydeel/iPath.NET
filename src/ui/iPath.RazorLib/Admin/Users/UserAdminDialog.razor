<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@User?.Username</MudText>
    </TitleContent>
    <DialogContent>
        <IPathHeader Title="Roles" Typo="Typo.h6" />
        <MudToggleGroup T="RoleDto" SelectionMode="SelectionMode.MultiSelection"
                        @bind-Values="selectedRoles" Outlined="true" Color="Color.Primary"
                        Class="my-8">
            @foreach (var r in allRoles)
            {
                <MudToggleItem T="RoleDto" Value="@r">@r.Name</MudToggleItem>
            }
        </MudToggleGroup>

        <MudCheckBox Label="active" @bind-Value="IsActive" />

        <IPathHeader Title="Profile" Typo="Typo.h6" Class="mt-8"/>
        <UserProfileForm Model="Profile" HideSaveButton="true" @ref="frm" />

    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save">Save</MudButton>
        <MudButton Variant="Variant.Filled" OnClick="Cancel">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@inject UserAdminViewModel vm

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public UserDto User { get; set; }

    private UserProfileForm frm;

    private IEnumerable<RoleDto> allRoles = [];
    private IEnumerable<RoleDto> selectedRoles = [];
    private UserProfile Profile;
    private bool IsActive { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (User != null)
        {
            allRoles = await vm.GetRoles();
            selectedRoles = User.Roles.ToList();
            Profile = User.Profile.Clone();
            IsActive = User.IsActive;
        }
    }

    async Task Save()
    {
        await frm.ValidateForm();

        var cmd = new UpdateUserAccountCommand { UserId = User.Id };
        if (IsActive != User.IsActive)
            cmd.IsActive = IsActive;

        if (!Profile.Equals(User.Profile))
            cmd.Profile = Profile;

        cmd.Roles = selectedRoles.Select(r => r.Id);
        await vm.SaveUserAccount(cmd);
        MudDialog.Close(true);
    }

    private void Cancel() => MudDialog.Cancel();
}
