@namespace iPath.Blazor.Componenents.Admin.Community
@using iPath.Application.Features.ServiceRequests
@using iPath.Blazor.Componenents.Admin.Communities

@inject CommunityAdminViewModel vm
@inject IStringLocalizer T
@inject IPathApi api
@inject NavigationManager nm

@if (Model is null)
{
    <LoadingMessage />
}
else
{
    <MudDataGrid Items="Items" Dense="true" Striped Class="ipath_table"
                 FixedHeader="true" Height="400px" Virtualize="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Questionnaires</MudText>
            <MudSpacer />
            <QuestionnaireLookup @bind-Value="selectedQ" @bind-Value:after="OnQuestionaireSelected" Clearable="true" @ref="lookup"
                                 Label=@T["Questionnaire"] MaxItems="100"
                                 Variant="Variant.Outlined" ShrinkLabel="true" Dense="true" Margin="Margin.Dense" />
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="q => q.NameAndId" Title="Name" />
            <PropertyColumn Property="q => q.Filter" Title="Body Site" />
            @foreach (var e in Usages)
            {
                <TemplateColumn Title="@e.ToString()">
                    <CellTemplate>
                        <MudCheckBox @bind-Value="@context.Item.Usage[e]"
                                     @bind-Value:after="@(() => vm.SaveQuestionnaireUsage(context.Item, e))" />
                    </CellTemplate>
                </TemplateColumn>
            }
        </Columns>
    </MudDataGrid>

    <MudButton Href="admin/communities" Variant="Variant.Filled" Class="mt-10">Ok</MudButton>
}

@code {
    [Parameter, EditorRequired]
    public CommunityDto Model { get; set; }

    List<CommunityQuestionnareModel> Items = new();
    QuestionnaireListDto? selectedQ;
    bool saving;

    QuestionnaireLookup lookup;

    eQuestionnaireUsage[] Usages => QuestionnairesViewModel.Usages;

    protected override async Task OnParametersSetAsync()
    {
        Items.Clear();
        if (Model is not null)
        {
            foreach (var q in Model.Questionnaires)
            {
                var item = Items.FirstOrDefault(x => x.QuestionnaireId == q.qId);
                if (item is null)
                {
                    item = new CommunityQuestionnareModel(q.qId, q.QuestinnaireId, q.QuestinnaireName, q.Settings?.BodySiteFilter?.ConceptCodesString, Model.Id);
                    Items.Add(item);
                }
                item.Usage[q.Usage] = true;
            }
        }
    }


    async Task OnQuestionaireSelected()
    {
        if (selectedQ is not null)
        {
            var item = Items.FirstOrDefault(x => x.QuestionnaireId == selectedQ.Id);
            if (item is null)
            {
                item = new CommunityQuestionnareModel(selectedQ.Id, selectedQ.QuestionnaireId, selectedQ.Name, selectedQ.Filter, Model.Id);
                Items.Add(item);
            }
            selectedQ = null;
            await lookup.ClearAsync();
            StateHasChanged();
        }
    }
}