@inject CodingService srv

<MudStack Row="@Row">
    <MudSelect T="CodedConcept" Margin="@Margin"
               ToStringFunc=@(x => x.ToDisplay())
               Variant="@Variant" Label="Organ System"
               Dense="true" ShrinkLabel="true" Clearable="true"
               @bind-Value="GroupCode" @bind-Value:after="OnGroupChanged">
        @foreach (var gr in groups.OrderBy(x => x.Code))
        {
            <MudSelectItem T="CodedConcept" Value="gr">
                @gr.Display [@gr.Code]
            </MudSelectItem>
        }
    </MudSelect>
    <MudSelect T="CodedConcept" Margin="@Margin"
               ToStringFunc=@(x => x.ToDisplay())
               Variant="@Variant" Label="@Label"
               Dense="true" ShrinkLabel="true" Clearable="true"
               @bind-Value="Code" @bind-Value:after="OnCodeChanged">
        @foreach (var c in groupCodes.OrderBy(x => x.Code))
        {
            <MudSelectItem T="CodedConcept" Value="c">
                @c.Display [@c.Code]
            </MudSelectItem>
        }
    </MudSelect>
</MudStack>


@code {
    [Parameter]
    public CodedConcept GroupCode { get; set; }

    [Parameter]
    public bool Row { get; set; }

    [Parameter]
    public CodedConcept Code { get; set; }

    [Parameter]
    public Margin Margin { get; set; } = Margin.Dense;

    private CodedConcept _code;

    [Parameter]
    public EventCallback<CodedConcept> CodeChanged { get; set; }

    async Task OnCodeChanged()
    {
        CodeChanged.InvokeAsync(Code);
    }

    async Task OnGroupChanged()
    {
        if (Code != null && GroupCode != null && !Code.Code.StartsWith(GroupCode.Code))
        {
            Code = null;
        }
        groupCodes = await srv.GetTopoConceptsForGroup(GroupCode?.Code);
    }

    protected override async Task OnInitializedAsync()
    {
        groups = await srv.GetTopoGroupConcepts();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Code is not null)
        {
            var gr = Code.Code.Split(".").FirstOrDefault();
            GroupCode = groups.SingleOrDefault(g => g.Code == gr); 
        }
    }

    private IEnumerable<CodedConcept> groups = [];
    private IEnumerable<CodedConcept> groupCodes = [];


    [Parameter]
    public string Label { get; set; } = "Topography";

    [Parameter]
    public Variant Variant { get; set; } = Variant.Outlined;
}
